
# Credit Risk Portfolio {#Sec:CreditModel}

```{r, include = FALSE}
#simulation of the credit model data (this will be removed)
{
  library(SWIM)
  set.seed(1)
  library(copula)
  nsim <- 100000
  
  #data
  m1 <- 2500 # counterparties tranche A
  m2 <- 5000 # counterparties tranche B
  m3 <- 2500 # counterparties tranche C
  
  p1 <- 0.0004 # prob of default 
  rho1 <- 0.0004 # correlation within the tranche

  p2 <- 0.0097 
  rho2 <- 0.0044
  
  p3 <- 0.0503  
  rho3 <- 0.01328
  
  #exposures
  e1 <- 80
  e2 <- 25 
  e3 <- 10 
  
  #loss given default
  LGD1 <- 0.25
  LGD2 <- 0.375
  LGD3 <- 0.5
  
  # beta-binomial model with copula 
  
  # beta parameters: matching tranches default probabilities and correlation
  alpha1 <- p1 * (1 / rho1 - 1)
  beta1 <- alpha1 * (1 / p1 - 1)
  
  alpha2 <- p2 * (1 / rho2 - 1)
  beta2 <- alpha2 * (1 / p2 - 1)
  
  alpha3 <- p3 * (1 / rho3 - 1)
  beta3 <- alpha3 * (1 / p3 - 1)
  
  # correlations between tranches
  cor12 <- 0.3
  cor13 <- 0.1
  cor23 <- 0.4
  
  # Gaussian copula structure
  myCop <- normalCopula(param = c(cor12, cor13, cor23), dim = 3, dispstr = "un")
  
  # define multivariate beta with given copula
  myMvd <- mvdc(copula = myCop,
                margins = c("beta", "beta", "beta"),
                paramMargins = list(list(alpha1, beta1),
                                    list(alpha2, beta2),
                                    list(alpha3, beta3)))
  
  # simulation from the chosen copula
  H <- rMvdc(nsim, myMvd)
  
  #simulate number of default per tranches (binomial distributions)
  M1 <- rbinom(n = nsim, size = m1, prob = H[, 1])
  M2 <- rbinom(n = nsim, size = m2, prob = H[, 2])
  M3 <- rbinom(n = nsim, size = m3, prob = H[, 3])
  
  #total loss per tranches
  L1 <- M1 * e1 * LGD1
  L2 <- M2 * e2 * LGD2
  L3 <- M3 * e3 * LGD3
  
  #global loss
  L <- L1 + L2 + L3
  
  #DB for SWIM
  credit_data <- cbind(L, L1, L2, L3, H)
  colnames(credit_data) <- c("L", "L1", "L2", "L3", "H1", "H2", "H3")
  }
```


The data set 

**insert**
data(creditportfolio)
**here**

contains 100,000 simulations of 7 variables $(L,L_1,L_2,L_3,H_1,H_2,H_3)$. The variables $L_1,L_2,L_3$ represent losses generated by three homogeneous subportfolios ranked according to their risk profile. Each subportfolio is homogeneous as of exposure, loss given default, default probability and correlation. The three dependent variables $H_1,H_2,H_3$ represent the common (conditional) default probability in each subportfolio. The total portfolio loss is $L=L_1+L_2+L_3$. The precise assumptions and parameter values defining this data set are in Appendix.


## Credit model example 

In this example we introduce a stress to the Value at Risk of the overall loss $L$; in particular, we require that $\text{VaR}_{90\%}(L)$ be increased by $20\%$. This can be achieved in **SWIM** using the `stress` function with the argument `type = "VaR"`:

```{r}
stress.credit <- stress(type = "VaR", x = credit_data, k = "L", alpha = 0.9, q_ratio = 1.2)
```

Further, we consider a second stress scenario under which, on top of the $20\%$ increase in $\text{VaR}_{90\%}(L)$, we add a $30\%$ increase in $\text{ES}_{90\%}(L)$. We decide to append this stress to the one already defined by setting `x = stress.credit`:

```{r}
stress.credit <- stress(type = "VaR ES", x = stress.credit, k = "L", alpha = 0.9, q_ratio = 1.2, s_ratio = 1.3)
```

++++MAYBE CHANGE THE SECOND STRESS ACCORDING TO ANDREAS' SUGGESTION? IE LEAVE VAR UNCHANGED (CURRENTLY NOT POSSIBLE) AND STRESS ES ONLY?

The `summary` function can be used to gather some information on a stressed object, and compare it to the original distribution (setting the option  `base = TRUE`):

```{r}
options(digits = 3)
summary(stress.credit, base = TRUE)
```

Note that information on the individual stresses can be recovered through the `get_specs` function, while `get_weight` allows to outsource the reweighting:

```{r}
options(digits = 3)
get_specs(stress.credit)
w <- get_weights(stress.credit)
colMeans(w)
```
+++HERE WE COULD USE THE "expected shortfall" FUNCTION (NOT AVAILABLE YET) TO CALCULATE THE EXPECTED SHORTFALL OF "stress.credit$stress1" 

To better appreciate the impact of the stresses and compare their effects on the variables $L, M_1, M_2$ and $M_3$, the `plot_hist` and `plot_cdf` functions can be used. The option `xCol` specifies  which column of the data should be considered while `wCol` allows to precise the weights to be considered. Note that these graphical functions return an object compatible with the package **ggplot2**. As a consequence we can, for example, apply the function `grid.arrange` (of the package **gridExtra**) to compare the four histograms together:

```{r}
library(gridExtra)
pL <- plot_hist(object = stress.credit, xCol = 1, wCol = 1, base = TRUE)
class(pL)
pL1 <- plot_hist(object = stress.credit, xCol = 2, wCol = 1, base = TRUE)
pL2 <- plot_hist(object = stress.credit, xCol = 3, wCol = 1, base = TRUE)
pL3 <- plot_hist(object = stress.credit, xCol = 4, wCol = 1, base = TRUE)
grid.arrange(pL, pL1, pL2, pL3, ncol = 2, nrow = 2)
```

It is also possible to compare more than one stress at a time in a single plot:

```{r}
plot_hist(object = stress.credit, xCol = 1, wCol = c(1,2),base = TRUE)
```

Both $L_2$ and $L_3$ are affected by the stress, while $L_1$'s distribution is almost unchanged. To obtain a more precise measure of the sensitivity of each factor to the stress can be obtained through the function `sensitivity`. In particular, with the default option `type = "Gamma", the function returns the ``Gamma'' sensitivity measure introduced in +++REVERSE SENSITIVITY?REPORT DEFINITION?+++.  Other available measures are based on the Kolmogorov and Wasserstein distances.

```{r}
sensitivity(object = stress.credit, xCol = c(2 : 7), wCol = 1, type = "Gamma")
```

Using the `sensitivity` function we can also analyse whether together the first and third tranches are able to exceed the riskiness of the second. This can be accomplished specifying, through the option `f`, a list of functions applicable to the columns `k` of the dataset. Finally, setting `xCol = NULL` allows to consider only the trasformed data:

```{r}
sensitivity(object = stress.credit,type = "Gamma", f = list(function(x)x[1] + x[2]), k = list(c(2,4)), xCol = NULL, wCol = 1)
```

The `importance_rank` function has the same structure of `sensitivity` but it will return the ranks, according to the absolute values, of the sensitivity measures. This function is particularly useful when there are several risk factors involved.

```{r}
importance_rank(object = stress.credit, xCol = c(2 : 7), wCol = 1, type = "Gamma")  
```

It transpires that subportfolios $2$ and $3$ are, in this order, most responsible for the stress in the global loss. Also, most of the sensitivity seems to be due to the systematic risk components $H_2$ and $H_3$. To confirm this, another stress resulting in the same $\text{VaR}_{90\%}(L)$, but controlling the distribution of $H_2$, can be imposed using the function `stress_moment`. More precisely, we impose that $E[H_2]$ and the $75\%$ quantile of $H_2$ are fixed as in the base model. 

```{r}
VaR.L <- quantile(x = credit_data[, "L"], prob = 0.9, type = 1)
q.H2 <- quantile(x = credit_data[, "H2"], prob = 0.75, type = 1)
str.var.credit2 <- stress_moment(x = credit_data,
                                f = list(function(x)1 * (x <= VaR.L * 1.2),
                                         function(x)x,
                                         function(x)1 * (x <= q.H2)),
                                m = c(0.9, mean(credit_data[, "H2"]), 0.75),
                                k = c(1, 6, 6))
# stress.credit <- stress_moment(x = stress.credit,
#                                f = list(function(x)1 * (x <= VaR.L * 1.2),
#                                         function(x)x,
#                                         function(x)1 * (x <= q.H2)),
#                                m = c(0.9, mean(credit_data[, "H2"]), 0.75), k = c(1, 6, 6))
summary(str.var.credit2)
# summary(stress.credit)
sensitivity(object = str.var.credit2, xCol = c(2 : 7), type = "Gamma")
# sensitivity(object = stress.credit, xCol = c(2 : 7), type = "Gamma")
```

+++THIS SHOULD BE APPENDED TO "stress.credit" WHEN "stress_moment" IS FIXED
It is then clear that systematic risk prevails on binomial (event) risk. 

The `stress_moment` function is flexible and allows different type of stresses to be imposed on a model. The following example forces a $50\%$ increase in correlation between the losses in the second and third portfolios, while keeping the means und standard deviations unchanged.

```{r}
m.L2 <- mean(credit_data[, "L2"])
m.L3 <- mean(credit_data[, "L3"])
m2.L2 <- mean(credit_data[, "L2"] ^ 2)
m2.L3 <- mean(credit_data[, "L3"] ^ 2)
cov.L2.L3 <- cov(credit_data[, "L2"], credit_data[, "L3"])
# str.var.credit2 <- stress_moment(x = credit_data,
#                                 f = list(function(x)x,
#                                          function(x)x,
#                                          function(x)x ^ 2,
#                                          function(x)x ^ 2,
#                                          function(x)x[1] * x[2] - m.L2 * m.L3),
#                                 k = list(3, 4, 3, 4, c(3, 4)),
#                                 m = c(m.L2, m.L3, m2.L2, m2.L3, cov.L2.L3 * 1.5)
```
+++CURRENTLY DOES NOT RUN - NEEDS TO BE FIXED OR REPLACED


+++FINAL COMMENTS?
