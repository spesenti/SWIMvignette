\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={SWIM: Scenario Weights for Importance Measurement},
            pdfauthor={Silvana M. Pesenti ,2, Alberto Bettini, Pietro Millossovich3,4, Andreas Tsanakas4},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{natbib}
\bibliographystyle{apalike}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{SWIM: Scenario Weights for Importance Measurement}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Silvana M. Pesenti\footnote{\href{mailto:silvana.pesenti@utoronto.ca}{\nolinkurl{silvana.pesenti@utoronto.ca}}} \textsuperscript{,2}, Alberto Bettini, Pietro Millossovich\textsuperscript{3,4}, Andreas Tsanakas\textsuperscript{4}}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{\textsuperscript{2}University of Toronto, \textsuperscript{3}DEAMS, University of Trieste Cass Business School, \textsuperscript{4}Cass Business School, City, University of London}


\begin{document}
\maketitle

{
\setcounter{tocdepth}{2}
\tableofcontents
}
\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

\hypertarget{abstract}{%
\subsection{Abstract}\label{abstract}}

The SWIM package is an efficient sensitivity analysis tool for stochastic models developed in \citet{Pesenti2019}. It provides a stressed version of a stochastic model, subject to model components (random variables) fulfilling given probabilistic constraints (stresses). Possible constraints include stressing moments, propability intervals and risk measures such as the Value-at-Risk and the Expected Shortfall. Provided with simulated scenarios from a stochastic model, the SWIM package returns scenario weights under which the stochastic model satisfies the stress and minimises the relative entropy with respect to the baseline model.

\hypertarget{background}{%
\subsection{Background}\label{background}}

a short literature review

\hypertarget{concepts-of-the-swim-package}{%
\subsection{\texorpdfstring{Concepts of the \texttt{SWIM} package}{Concepts of the SWIM package}}\label{concepts-of-the-swim-package}}

\hypertarget{installation}{%
\subsubsection{Installation}\label{installation}}

The SWIM package can be install from \href{https://CRAN.R-project.org/package=SWIM}{CRAN} :

\begin{quote}
\url{https://CRAN.R-project.org/package=SWIM};
\end{quote}

alternatively from \href{https://github.com/spesenti/SWIM}{GitHub} in R studio:

\begin{verbatim}
install.packages("spesenti/SWIM")
\end{verbatim}

\hypertarget{structure-of-the-vignette}{%
\subsection{Structure of the vignette}\label{structure-of-the-vignette}}

Section \ref{Sec:Scope} contains the mathematical background and the description of the optimisation that underlies the implementation of the SWIM package. For readers interested in the application and usage of the SWIM package, Section \ref{Sec:Scope} can serve as a reference, as all implemented \texttt{R} functions, including stresses and graphical and analysis tools are described in detail.

\hypertarget{what-is-swim}{%
\section{What is SWIM?}\label{what-is-swim}}

\hypertarget{sensitivity-testing-and-scenario-weights}{%
\subsection{Sensitivity testing and scenario weights}\label{sensitivity-testing-and-scenario-weights}}

The purpose of SWIM is to enable sensitivity analysis of models implemented in a Monte Carlo simulation framework, by distorting (`stressing') some of the models' components and monitoring the resulting impact on quantities of interest.

To clarify this idea and explain how SWIM works, we first define the terms used. By a \emph{model}, we mean a set of \(n\) (typically simulated) realisations from a vector of random variables \((X_1,\dots,X_d)\), along with \emph{scenario weights} \(W\) assigned to individual realisations, as shown in the table below. Hence each of of the columns 1 to \(d\) corresponds to a random variable, called a \emph{model component}, while each row corresponds to a \emph{scenario}, that is, a state of the world.

\begin{longtable}[]{@{}ccccc@{}}
\toprule
\(X_1\) & \(X_2\) & \(\dots\) & \(X_d\) & \(W\)\tabularnewline
\midrule
\endhead
\(x_{11}\) & \(x_{21}\) & \(\dots\) & \(x_{d1}\) & \(w_1\)\tabularnewline
\(x_{12}\) & \(x_{22}\) & \(\dots\) & \(x_{d2}\) & \(w_2\)\tabularnewline
\(\dots\) & \(\dots\) & \(\dots\) & \(\dots\) & \(\dots\)\tabularnewline
\(x_{1n}\) & \(x_{2n}\) & \(\dots\) & \(x_{dn}\) & \(w_n\)\tabularnewline
\bottomrule
\end{longtable}

Each scenario has a \emph{scenario weight}, shown in the last column, such that, scenario \(i\) has probability \(\frac{w_i}{n}\) of occurring. Scenario weights are always greater and equal than zero and have an average of 1. When all scenario weights are equal to 1, such that the probability of each scenario is \(\frac 1 n\) (the standard Monte Carlo framework), we call the model a \emph{baseline model} -- and consequently never explicitly talk about the scenario weights of baseline models. When scenario weights are not identically equal to 1, we say that we have a \emph{stressed model}.

The scenario weights make the joint distribution of model components under the stressed model different, compared to the baseline model. For example, under the baseline model, the expected value of \(X_1\) and the cumulative distribution function of \(X_1\) at threshold \(t\), are respectively given by:
\[
E(X_1)=\frac 1  n \sum_{i=1}^nx_{1i},\quad F_{X_1}(t)= P(X_1\leq t)=\frac 1 n \sum_{i=1}^n \mathbf 1 _{x_{1i}\leq t},
\]
where \(\mathbf 1 _{x_{1i}\leq t}=1\) if \(x_{1i}\leq t\) and \(0\) otherwise. For a stressed model with scenario weights \(W\), the expected value and distribution function become:
\[
E^W(X_1)=\frac 1  n \sum_{i=1}^n w_i x_{1i},\quad F_{X_1}^W(t)=P^W(X_1\leq t)=\frac 1 n \sum_{i=1}^n w_i \mathbf 1 _{x_{1i}\leq t}.
\]
Similar expressions can be derived for more involved quantities, such as higher (joint) moments and quantiles.

The logic of stressing a model with SWIM then proceeds as follows. An analyst or modeller is supplied with a baseline model, in the form of a matrix of equiprobable simulated scenarios of model components. The modeller wants to investigate the impact of a change in the distribution of, say, \(X_1\). To this effect, she chooses a set of scenario weights, such that the stressed distribution of \(X_1\) satisfies a particular constraint, e.g.~\(E^W(X_1)=m\), which we call a \emph{stress}; we then say that she is \emph{stressing} \(X_1\) and, by extension, the model. The scenario weights are chosen such that the distortion to the baseline model induced by the stress is as small as possible; specifically in SWIM the Kullback-Leibler divergence (or relative entropy) between the baseline and stressed models is minimised, subject to the constraint of the stress (see Section \ref{Rfunctions} for more detail on the different types of possible stresses and the corresponding optimisation problems).

Once scenario weights are obtained, they can be used to obtain the stressed distribution of any model component or any function of model components. For example, for scenario weights \(W\) obtained through a stress on \(X_1\), we may calculate
\[
E^W(X_2)=\frac 1  n\sum_{i=1}^n w_i x_{2i},\quad E^W(X_1^2+X_2^2)=\frac 1  n \sum_{i=1}^n w_i \left(x_{1i}^2+ x_{2i}^2 \right).
\]
Through this process the modeller can monitor the impact of the stress on \(X_1\) on any other random variable of interest. It is notable that this approach does not necessitate generating new simulations from a stochastic model. However, as the SWIM approach requires a single set of simulated scenarios (the baseline model) it offers a clear computational benefit.

\hypertarget{an-introductory-example}{%
\subsection{An introductory example}\label{an-introductory-example}}

Here, through an example, we illustrate the basic concepts and usage of SWIM for sensitivity analysis. More advanced usage of SWIM and options for constructing stresses are demonstrated in Sections xxx.

We consider a simple model, with the random variables \(Z_1,Z_2,Z_3\) represent normally distributed losses in a portfolio. \(Z_1\) and \(Z_2\) are correlated, while \(Z_3\) is independent of \((Z_1,Z_2)\). The portfolio loss is defined by \(Y=Z_1+Z_2+Z_3\). Our purpose in this example is to investigate how a stress on the loss \(Z_1\), impacts on the overall portfolio loss \(Y\).

First we derive simulated data from the random vector \((Z_1,Z_2,Z_3,Y)\), forming our baseline model.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\CommentTok{# number of simulated scenarios}
\NormalTok{n.sim <-}\StringTok{ }\DecValTok{10}\OperatorTok{^}\DecValTok{5}
\CommentTok{# correlation between Z1 and Z2}
\NormalTok{r <-}\StringTok{ }\FloatTok{0.5}
\CommentTok{# simulation of Z1  and Z2}
\CommentTok{# simple construction as combination of independent standard normals U1, U2}
\NormalTok{U1 <-}\StringTok{ }\KeywordTok{rnorm}\NormalTok{(n.sim)}
\NormalTok{U2 <-}\StringTok{ }\KeywordTok{rnorm}\NormalTok{(n.sim)}
\NormalTok{Z1 <-}\StringTok{ }\DecValTok{100} \OperatorTok{+}\StringTok{ }\DecValTok{40} \OperatorTok{*}\StringTok{ }\NormalTok{U1}
\NormalTok{Z2 <-}\StringTok{ }\DecValTok{100} \OperatorTok{+}\StringTok{ }\DecValTok{20} \OperatorTok{*}\StringTok{ }\NormalTok{(r }\OperatorTok{*}\StringTok{ }\NormalTok{U1 }\OperatorTok{+}\StringTok{ }\KeywordTok{sqrt}\NormalTok{(}\DecValTok{1} \OperatorTok{-}\StringTok{ }\NormalTok{r}\OperatorTok{^}\DecValTok{2}\NormalTok{) }\OperatorTok{*}\StringTok{ }\NormalTok{U2)}
\CommentTok{# simulation of Z3}
\NormalTok{Z3 <-}\StringTok{ }\KeywordTok{rnorm}\NormalTok{(n.sim, }\DecValTok{100}\NormalTok{, }\DecValTok{20}\NormalTok{)}
\CommentTok{# portfolio loss Y}
\NormalTok{Y <-}\StringTok{ }\NormalTok{Z1 }\OperatorTok{+}\StringTok{ }\NormalTok{Z2 }\OperatorTok{+}\StringTok{ }\NormalTok{Z3}
\end{Highlighting}
\end{Shaded}

Now we introduce a stress to our baseline model. For our first stress, we require that the mean of \(Z_1\) is increased from 100 to 110. This is done using the \texttt{stress} function, which generates as output the SWIM object \texttt{str.mean}. This object stores the stressed model, i.e.~the realisations of the model components and the scenario weights. In the function call, \texttt{k=1} indicates that the stress is applied on the first column of \texttt{dat}, that is, on the realisations of the random variable \(Z_1\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(SWIM)}
\NormalTok{dat <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(Z1, Z2, Z3, Y)}
\NormalTok{str.mean <-}\StringTok{ }\KeywordTok{stress}\NormalTok{(}\DataTypeTok{type=}\StringTok{"mean"}\NormalTok{, }\DataTypeTok{x =}\NormalTok{ dat, }\DataTypeTok{k=}\DecValTok{1}\NormalTok{, }\DataTypeTok{new_means =} \DecValTok{110}\NormalTok{)}
\KeywordTok{summary}\NormalTok{(str.mean, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $base
##                    Z1        Z2        Z3         Y
## mean         1.00e+02  99.94040  99.98433 299.98111
## sd           4.00e+01  19.99695  19.98195  56.63887
## skewness    -6.08e-04   0.00117  -0.00247  -0.00234
## ex kurtosis -1.06e-02  -0.00897  -0.01257  -0.00938
## 1st Qu.      7.28e+01  86.47450  86.48161 261.61212
## Median       1.00e+02  99.98657 100.00907 300.05480
## 3rd Qu.      1.27e+02 113.39567 113.49342 338.26698
## 
## $`stress 1`
##                    Z1        Z2        Z3         Y
## mean        110.00000 102.44371  99.98278 312.42649
## sd           40.03328  19.99542  19.97616  56.61726
## skewness     -0.00240  -0.00151  -0.00493  -0.00368
## ex kurtosis  -0.00502  -0.00316  -0.01547  -0.00119
## 1st Qu.      82.99837  88.97706  86.48152 274.22003
## Median      110.07585 102.48100  99.99544 312.50394
## 3rd Qu.     136.93102 115.87438 113.50186 350.61205
\end{verbatim}

The summary function, applied on the SWIM object \texttt{str.mean}, shows how the distributional characteristics of all random variables of interest change from the baseline to the stressed model. In particular, we see that the mean of \(Z_1\) changes to its required value, while the mean of \(Y\) also increases. Furthermore there is a small impact on \(Z_2\), due to its positive correlation to \(Z_1\).

Beyond considering the standard statistics evaluated via the summary function, stressed probability distributions can be plotted. In Figure \ref{fig:example1-cdfs-mean} we show the impact of the stress on on the cumulative distribution functions (cdf) of \(Z_1\) and \(Y\). It is seen how the stressed cdfs are lower than the original (baseline) ones. Loosely speaking, this demonstrates that the stress has increased (in a stochastic sense) both random variables \(Z_1\) and \(Y\). While the stress was on \(Z_1\), the impact on the distribution of the portfolio \(Y\) is clearly visible.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# can refer to variable of interest by name...}
\KeywordTok{plot_cdf}\NormalTok{(str.mean, }\DataTypeTok{xCol =} \StringTok{"Z1"}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\CommentTok{# ... or column number}
\KeywordTok{plot_cdf}\NormalTok{(str.mean, }\DataTypeTok{xCol =} \DecValTok{4}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-cdfs-mean-1} \includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-cdfs-mean-2} \caption{Baseline and stressed empirical distribution functions of model components  $Z_1$ (left) and $Y$ (right), subject to a stress on the mean of $Z_1$.}\label{fig:example1-cdfs-mean}
\end{figure}

The scenario weights, given their central role, can be extracted from a SWIM object. In Figure \ref{fig:example1-weights-mean}, the scenario weights from \texttt{str.mean} are plotted against realisations from \(Z_1\) and \(Y\) respectively. It is seen how the weights are increasing in the realisations from \(Z_1\). This is a consequence of the weights' derivation via a stress on the model component \(Z_1\). The increasingness shows that those scenarios for which \(Z_1\) is largest are assigned a higher weight. The relation between scenario weights and \(Y\) is still increasing (reflecting that high outcomes of \(Y\) tend to receive higher weights), but no longer deterministic (showing that \(Y\) is not completely driven by changes in \(Z_1\)).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# extract weights from SWIM object}
\NormalTok{w.mean <-}\StringTok{ }\KeywordTok{get_weights}\NormalTok{(str.mean)}
\KeywordTok{plot}\NormalTok{(Z1[}\DecValTok{1} \OperatorTok{:}\StringTok{ }\DecValTok{5000}\NormalTok{], w.mean[}\DecValTok{1} \OperatorTok{:}\StringTok{ }\DecValTok{5000}\NormalTok{], }\DataTypeTok{pch =} \DecValTok{20}\NormalTok{, }\DataTypeTok{xlab =} \StringTok{"Z1"}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{"scenario weights"}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(Y[}\DecValTok{1} \OperatorTok{:}\StringTok{ }\DecValTok{5000}\NormalTok{], w.mean[}\DecValTok{1} \OperatorTok{:}\StringTok{ }\DecValTok{5000}\NormalTok{], }\DataTypeTok{pch =} \DecValTok{20}\NormalTok{, }\DataTypeTok{xlab =} \StringTok{"Y"}\NormalTok{, }\DataTypeTok{ylab =} \StringTok{"scenario weights"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-weights-mean-1} \includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-weights-mean-2} \caption{Scenario weights against observations of model components  $Z_1$ (left) and $Y$ (right), subject to a stress on the mean of $Z_1$.}\label{fig:example1-weights-mean}
\end{figure}

Stress the mean of \(Z_1\) did not impact the volatility of either \(Z_1\) or \(Y\), as can be seen by the practically unchanged standard deviations in the output of \texttt{summary(str.mean)}. Thus, we introduce an alternative stress that keeps the mean of \(Z_1\) fixed at 100, but increases its standard deviation from 40 to 50. This new stress is seen to impact the standard deviation of the portfolio loss \(Y\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str.sd <-}\StringTok{ }\KeywordTok{stress}\NormalTok{(}\DataTypeTok{type=}\StringTok{"mean sd"}\NormalTok{, }\DataTypeTok{x =}\NormalTok{ dat, }\DataTypeTok{k=}\DecValTok{1}\NormalTok{, }\DataTypeTok{new_means =} \DecValTok{100}\NormalTok{, }\DataTypeTok{new_sd=}\DecValTok{50}\NormalTok{)}
\KeywordTok{summary}\NormalTok{(str.sd, }\DataTypeTok{base =} \OtherTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $`stress 1`
##                    Z1        Z2        Z3         Y
## mean        100.00000  99.94055  99.97817 299.91872
## sd           50.00050  21.34937  19.97997  67.92330
## skewness     -0.00272   0.00703  -0.00342   0.00491
## ex kurtosis  -0.05561  -0.03317  -0.00612  -0.04270
## 1st Qu.      66.09643  85.49520  86.48219 253.74962
## Median      100.12904  99.97427 100.04553 299.97662
## 3rd Qu.     133.77335 114.30108 113.47008 345.91590
\end{verbatim}

Furthermore, in Figure \ref{fig:example1-cdfs-sd}, we compare the baseline and stressed cdfs of \(Z_1\) and \(Y\), under the new stress on \(Z_1\). The crossing of probability distribution reflects the increase in volatility.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot_cdf}\NormalTok{(str.sd, }\DataTypeTok{xCol =} \StringTok{"Z1"}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\KeywordTok{plot_cdf}\NormalTok{(str.sd, }\DataTypeTok{xCol =} \DecValTok{4}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-cdfs-sd-1} \includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-cdfs-sd-2} \caption{Baseline and stressed empirical distribution functions of model components  $Z_1$ (left) and $Y$ (right), subject to a stress on the standard deviation of $Z_1$.}\label{fig:example1-cdfs-sd}
\end{figure}

The different ways how a stress on the standard deviation of \(Z_1\), compared to a stress on its mean, impact on the model, is reflected by the scenario weights. Figure \ref{fig:example1-weights-sd} shows the pattern of the scenario weights and how, when stressing standard deviations, higher weight is placed on scenarios where \(Z_1\) is extreme, either much lower or much higher than its mean of 100.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{w.sd <-}\StringTok{ }\KeywordTok{get_weights}\NormalTok{(str.sd)}
\KeywordTok{plot}\NormalTok{(Z1[}\DecValTok{1}\OperatorTok{:}\DecValTok{5000}\NormalTok{],w.sd[}\DecValTok{1}\OperatorTok{:}\DecValTok{5000}\NormalTok{],}\DataTypeTok{pch=}\DecValTok{20}\NormalTok{,}\DataTypeTok{xlab=}\StringTok{"Z1"}\NormalTok{,}\DataTypeTok{ylab=}\StringTok{"scenario weights"}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(Y[}\DecValTok{1}\OperatorTok{:}\DecValTok{5000}\NormalTok{],w.sd[}\DecValTok{1}\OperatorTok{:}\DecValTok{5000}\NormalTok{],}\DataTypeTok{pch=}\DecValTok{20}\NormalTok{,}\DataTypeTok{xlab=}\StringTok{"Y"}\NormalTok{,}\DataTypeTok{ylab=}\StringTok{"scenario weights"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}
\includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-weights-sd-1} \includegraphics[width=0.5\linewidth]{01-intro_files/figure-latex/example1-weights-sd-2} \caption{Scenario weights against observations of model components  $Z_1$ (left) and $Y$ (right), subject to a stress on the standard deviation of $Z_1$.}\label{fig:example1-weights-sd}
\end{figure}

Finally we ought to note that not all stresses that one may wish to apply are feasible. Assume for example that we want to increase the mean of \(Z_1\) from 100 to 300, which exceeds the maximum realisation of \(Z_1\) in the baseline model. Then, clearly, no set of scenario weights can be found that produce a stress that yields the required mean for \(Z_1\); consequently an error message is produced.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{str.sd <-}\StringTok{ }\KeywordTok{stress}\NormalTok{(}\DataTypeTok{type=}\StringTok{"mean"}\NormalTok{,}\DataTypeTok{x =}\NormalTok{ dat, }\DataTypeTok{k=}\DecValTok{1}\NormalTok{, }\DataTypeTok{new_means =} \DecValTok{300}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in stress_moment(x = x, f = means, k = k, m = new_means, ...): Values in m must be in the range of f(x).
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{max}\NormalTok{(Z1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 273
\end{verbatim}

\hypertarget{Sec:Scope}{%
\section{Scope of the SWIM package}\label{Sec:Scope}}

\hypertarget{Rfunctions}{%
\subsection{Stressing a model}\label{Rfunctions}}

While the SWIM package is designed to work on (Monte Carlo) realisations of model components, the scenario weights are derived in a general probabilistic framework. A baseline probability (representing the equiprobable Monte Carlo simulations) can be described by a probability measure \(P\), and a stressed model by a different probabitlity measures \(Q\). The stressed model is uniquely described by the change from the baseline to the stressed model, which can be seen as the scenario weights \(W= \frac{dQ}{dP}\). A stressed model, under which the distribution of the model components fulfil specific stresses, is chosen such that the distortion to the baseline model is as small as possible in the Kullback-Leibler divergence (or relative entropy). Mathematically, a stressed model is the solutions to.
\begin{equation} 
\min_{ W } ~E(W \log (W)), \quad
\text{subject to constraints under } P^W.
\label{eq:optimisation}
\end{equation}
Subsequently, we denote by a superscript \(W\) the quantity of interest under the stressed model, such as \(P^W, ~ E^W\) for the probabtility distribution and expectation under the stressed model, respectivley. We refer to \citet{Pesenti2019} and references therein for further mathematical details and the derivations of solutions to \eqref{eq:optimisation}.

The subsequent table is a collection of all implemented types of stresses. The pricise constraints of \eqref{eq:optimisation} are explained below.

\begin{longtable}[]{@{}llll@{}}
\toprule
\begin{minipage}[b]{0.20\columnwidth}\raggedright
R function\strut
\end{minipage} & \begin{minipage}[b]{0.39\columnwidth}\raggedright
Stress\strut
\end{minipage} & \begin{minipage}[b]{0.09\columnwidth}\raggedright
\texttt{type}\strut
\end{minipage} & \begin{minipage}[b]{0.20\columnwidth}\raggedright
Reference\strut
\end{minipage}\tabularnewline
\midrule
\endhead
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
wrapper for the \texttt{stress\_type} functions\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
Section \ref{Rstress}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_user()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
user defined scenario weights\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{user}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_prob()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
disjoint intervals\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{prob}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\eqref{eq:optimisationprob}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_mean()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
means\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{mean}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\eqref{eq:optimisationmoment}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_mean\_sd()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
means and standard deviations\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{mean\ sd}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\eqref{eq:optimisationmoment}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_moment()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
moments, functions of moments\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{moment}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\eqref{eq:optimisationmoment}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_VaR()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
VaR risk measure, a quantile\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{VaR}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\eqref{eq:optimisationVaR}\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.20\columnwidth}\raggedright
\texttt{stress\_VaR\_ES()}\strut
\end{minipage} & \begin{minipage}[t]{0.39\columnwidth}\raggedright
VaR and ES risk measures\strut
\end{minipage} & \begin{minipage}[t]{0.09\columnwidth}\raggedright
\texttt{VaR\ ES}\strut
\end{minipage} & \begin{minipage}[t]{0.20\columnwidth}\raggedright
\eqref{eq:optimisationVaRES}\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{Rstress}{%
\subsubsection{\texorpdfstring{The \texttt{stress} function and the \texttt{SWIM} object}{The stress function and the SWIM object}}\label{Rstress}}

The \texttt{stress()} function is a wapper for the \texttt{stress\_} functions, with \texttt{stress(type\ =\ "type",\ ...\ )} and \texttt{stress\_type(...)} being equivalent. The \texttt{stress()} function solves optimisation \eqref{eq:optimisation} for constraints specified through \texttt{type}and returns a \texttt{SWIM} object containing a list of:

\begin{longtable}[]{@{}ll@{}}
\toprule
\endhead
\texttt{x} & realistaions of the model\tabularnewline
\texttt{new\_weights} & scenario weights\tabularnewline
\texttt{type} & ``type'' of stress\tabularnewline
\texttt{specs} & details about the stress\tabularnewline
\bottomrule
\end{longtable}

The data frame, \texttt{x} in the above table, containing the realisations of the baseline model, can be extracted from a \texttt{SWIM} object using \texttt{get\_data()}. Similarly, \texttt{get\_weights()} and \texttt{get\_weightsfun()} provide the scenario weights, respectively the functions, that when applied to \texttt{x} generate the scenarion weights. The specification of the applied stress can be obtained using \texttt{get\_specs()}.

\hypertarget{stressing-disjoint-probability-intervals}{%
\subsubsection{Stressing disjoint probability intervals}\label{stressing-disjoint-probability-intervals}}

Stressing disjoint probability intervals, allows to define stresses by altering regions or events of a model component. The scenario weights are calculated via \texttt{stress\_prob()}, or equivalently \texttt{stress(type\ =\ "prob",\ ...)}, and the stressed probability intervals are specified through the \texttt{lower} and \texttt{upper} endpoints of the intervals.

\begin{quote}
For disjoint intervals \(B_1, \ldots, B_I\) with \(P(X \in B_i) >0\), for all \(i = 1, \ldots, I\), and \(\alpha_1, \ldots, \alpha_I > 0\) such that \(\alpha_1 + \ldots + \alpha_I < 1\), \texttt{stress\_prob()} solves for the constraints
\begin{equation} 
P^W(X \in B_i) = \alpha_i, ~i = 1, \ldots, I. \label{eq:optimisationprob}
\end{equation}
\end{quote}

\hypertarget{stressing-moments}{%
\subsubsection{Stressing moments}\label{stressing-moments}}

The functions \texttt{stress\_mean()}, \texttt{stress\_mean\_sd()} and \texttt{stress\_moment()} can be applied to multiple model components and are the only \texttt{stress} functions that have scenrio weights calculated via numerical optimisation using the \href{https://CRAN.R-project.org/package=nleqslv}{nleqslv} package. Thus, dependending on the choice of moment stresses, existence of a stressed model is not guaranteed.

\begin{quote}
For \(i = 1, \ldots, I\) with \(J_i \subset \{1, \ldots, n\}\) and functions \(f_i \colon \mathbb{R}^{J_i} \to \mathbb{R}\), \texttt{stress\_moment()} solves for the constraints
\begin{equation} 
E^W(f_i(X_{J_i}) ) = m_i, ~i = 1, \ldots, I. \label{eq:optimisationmoment}
\end{equation}
\end{quote}

\hypertarget{stressing-risk-measures}{%
\subsubsection{Stressing risk measures}\label{stressing-risk-measures}}

The functions \texttt{stress\_VaR} and \texttt{stress\_VaR\_ES} provides stressed models, under which a model components fulfils a stress on the Value-at-Risk (\(\text{VaR}\)) and/or Expected Shortfall (\(\text{ES}\)) risk measures. The \(\text{VaR}\) at level \(0 < \alpha < 1\) of a random variable \(Z\) with distrbution \(F\), is defined as the \(\alpha-\)quantile of \(F\), that is \[\text{VaR}_\alpha(Z) = F^{-1}(\alpha).\] The \(\text{ES}\) at level \(0 < \alpha < 1\) of a random variable \(Z\) is given by \[\text{ES}_\alpha(Z) = \int_0^1 \text{VaR}_u(Z) \mathrm{d}u.\]

\begin{quote}
For \(0< \alpha <1\) and \(q, s \in \mathbb{R}\) such that \(\text{VaR}_{\alpha}(Y)<q < s\), \texttt{stress\_VaR()} solves for the constraints
\begin{equation} 
\text{VaR}_{\alpha }^W(Y) = q;  \label{eq:optimisationVaR}
\end{equation}
and \texttt{stress\_VaR\_ES()} solves for the constraints
\begin{equation}                                                
\text{VaR}_{\alpha }^W(Y) = q, \text{ ES}_{\alpha }^W(Y) = s.\label{eq:optimisationVaRES}
\end{equation}
\end{quote}

\hypertarget{Sec:analysis}{%
\subsection{Analysis of stressed models}\label{Sec:analysis}}

The function \texttt{summary()} is a methods for an object of class SWIM and provides summary statistics of the baseline and stressed models. If the SWIM object contains more than one set of scenario weights, each corresponding to one stressed model, the \texttt{stress()} function returns for each set of scenarion weights a list containting:

\begin{longtable}[]{@{}ll@{}}
\toprule
\endhead
\texttt{mean} & sample mean\tabularnewline
\texttt{sd} & sample standard deviation\tabularnewline
\texttt{skewness} & sample skewness\tabularnewline
\texttt{ex\ kurtosis} & sample excess kurtosis\tabularnewline
\texttt{1st\ Qu.} & 25\% quantile\tabularnewline
\texttt{Median} & median, 50\% quantile\tabularnewline
\texttt{3rd\ Qu.} & 75\% quantile\tabularnewline
\bottomrule
\end{longtable}

The empirical distribution functions of model components under a stressed model can be calculated by evaluation of \texttt{cdf()} on a SWIM object. It is important to note, that the standard empirical distribution function, \texttt{ecdf()} applied to a SWIM object will \textbf{not} return empirical distribution functions under a stressed model. Similarly, to calculate sample quantiles of stressed models components, the function \texttt{quantile\_stressed()} should be used. Implemented visualisation of distribution functions are \texttt{plot\_cdf()}, for plotting empirical distribution functions, and \texttt{plot\_hist()}, for plotting histograms of model components under stressed models.

Comparison of baseline and stressed models and how stressed model impact model components, can be done via the \texttt{sensitivity()} function. The implemented sensitivity measures are summarised in the table below. The Wasserstein and Kolmogorov, sensitivities are to compare stressed (and baseline) models, as these sensitivities only depend on the scenario weights, whereas the Gamma sensitivity is useful to compare the impact of a stress model on the model components.

\begin{longtable}[]{@{}lll@{}}
\toprule
\endhead
\begin{minipage}[t]{0.30\columnwidth}\raggedright
Wasserstein\strut
\end{minipage} & \begin{minipage}[t]{0.30\columnwidth}\raggedright
\(\int | F^W_X (x) - F_X(x)| dx\)\strut
\end{minipage} & \begin{minipage}[t]{0.30\columnwidth}\raggedright
comparing models\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\raggedright
Kolmogorov\strut
\end{minipage} & \begin{minipage}[t]{0.30\columnwidth}\raggedright
\(\sup_x |F^W_X (x) - F_X(x)|\)\strut
\end{minipage} & \begin{minipage}[t]{0.30\columnwidth}\raggedright
comparing models\strut
\end{minipage}\tabularnewline
\begin{minipage}[t]{0.30\columnwidth}\raggedright
Gamma\strut
\end{minipage} & \begin{minipage}[t]{0.30\columnwidth}\raggedright
\(\frac{E^W(X) - E(X)}{c}\), for a normalisation \(c\)\strut
\end{minipage} & \begin{minipage}[t]{0.30\columnwidth}\raggedright
comparing model components\strut
\end{minipage}\tabularnewline
\bottomrule
\end{longtable}

The normalisation for the Gamma sensitivity is such that Gamma takes values between -1 and 1, where positive values correspond to a larger impact on a larger impact. The sensitivities of model components can be plotted using \texttt{plot\_sensitivity()}. The function \texttt{importance\_rank()}, returns the effective rank of model component according ot the chosen sensitivity measures.

\hypertarget{Sec:CreditModel}{%
\section{Simulation study}\label{Sec:CreditModel}}

\hypertarget{the-credit-risk-portfolio}{%
\subsection{The credit risk portfolio}\label{the-credit-risk-portfolio}}

The credit model in this section is a conditionally binomial credit model and we refer to the Appendix \ref{AppendixCM} for details and the generation of the simulated data. Of interest ist the total aggregate portfolio loss \(L = L_1 + L_2 + L_3\), where \(L_1, L_2, L_3\) are homogeneous subportfolios on comparable scale. The data set contains 100,000 simulations of the portfolio \(L\), the sub-portfolios \(L_1, L_2, L_3\) as well as the (conditional) default probability of each subportfolio \(H_1, H_2, H_3\). A snipped of data set looks as follows:

\begin{verbatim}
##         L L1    L2  L3       H1      H2     H3
## [1,]  692  0 346.9 345 1.24e-04 0.00780 0.0294
## [2,] 1006 60 515.6 430 1.16e-03 0.01085 0.0316
## [3,] 1661  0 806.2 855 5.24e-04 0.01490 0.0662
## [4,] 1708  0 937.5 770 2.58e-04 0.02063 0.0646
## [5,]  807  0  46.9 760 8.06e-05 0.00128 0.0632
## [6,] 1159 20 393.8 745 2.73e-04 0.00934 0.0721
\end{verbatim}

\hypertarget{stressing-the-aggregate-portfolio-loss}{%
\subsection{Stressing the aggregate portfolio loss}\label{stressing-the-aggregate-portfolio-loss}}

In this section, we study the effect of stresses on (the tail of) the aggregate portfolio on the three sub-portfolios. First, we stress the \(VaR_{0.9}\) of the total loss of the aggregate portfolio by \(20\%\). For this we use the \texttt{stress} function with the argument \texttt{type\ =\ "VaR"}. The input parameter \texttt{x} is the simulated data, \texttt{k} corresponds to the name of the row of \texttt{x} on which the stress is applied to, \texttt{alpha} determines the level of the stresses VaR and \texttt{q\_ratio} the percentage increase.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stress.credit <-}\StringTok{ }\KeywordTok{stress}\NormalTok{(}\DataTypeTok{type =} \StringTok{"VaR"}\NormalTok{, }\DataTypeTok{x =}\NormalTok{ credit_data, }\DataTypeTok{k =} \StringTok{"L"}\NormalTok{, }
                        \DataTypeTok{alpha =} \FloatTok{0.9}\NormalTok{, }\DataTypeTok{q_ratio =} \FloatTok{1.2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Second, we consider, additionally to the \(20\%\) increase in \(\text{VaR}_{0.9}\), a \(30\%\) increase in \(\text{ES}_{0.9}\) of the aggregate portfolio \(L\). Generating a stressed model, resulting from a simultaneous stress on the VaR and the ES can be acchieve using \texttt{type\ =\ "VaR\ ES"}. Note that both VaR and ES need be stressed at the same level \texttt{alpha\ =\ 0.9}. The additonal input parameter \texttt{s\_ratio} determines the percentage increase in the ES. Instead of providing the percentage inceases in the VaR and ES, the \texttt{stress} function allows for the actual stressed values of the VaR and ES using the parameters \texttt{s} and \texttt{q} instead of \texttt{s\_ratio} and \texttt{q\_ratio}, respectively.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stress.credit <-}\StringTok{ }\KeywordTok{stress}\NormalTok{(}\DataTypeTok{type =} \StringTok{"VaR ES"}\NormalTok{, }\DataTypeTok{x =}\NormalTok{ stress.credit, }\DataTypeTok{k =} \StringTok{"L"}\NormalTok{, }
                        \DataTypeTok{alpha =} \FloatTok{0.9}\NormalTok{, }\DataTypeTok{q_ratio =} \FloatTok{1.2}\NormalTok{, }\DataTypeTok{s_ratio =} \FloatTok{1.3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Note, that as input \texttt{x} we used the above calucalted stressed model, resulting from a stress on the \(VaR_{0.9}\). Using a stressed model as an input for the \texttt{stress} function is convenient for large data sets, as the \texttt{stress} function returns an object (\texttt{stress.credit}) that countains the original simualted data and the scenario weights.

++++MAYBE CHANGE THE SECOND STRESS ACCORDING TO ANDREAS' SUGGESTION? IE LEAVE VAR UNCHANGED (CURRENTLY NOT POSSIBLE) AND STRESS ES ONLY?

\hypertarget{analysing-the-stressed-model}{%
\subsection{Analysing the stressed model}\label{analysing-the-stressed-model}}

The \texttt{summary} function provides a statistical summary of the stressed models. Choosing \texttt{base\ =\ TRUE}, compares the stressed models with the the simulated data - the baseline model.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{summary}\NormalTok{(stress.credit, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $base
##                    L    L1     L2      L3       H1      H2     H3
## mean        1102.914 19.96 454.04 628.912 0.000401 0.00968 0.0503
## sd           526.538 28.19 310.99 319.715 0.000400 0.00649 0.0252
## skewness       0.942  2.10   1.31   0.945 1.969539 1.30834 0.9501
## ex kurtosis    1.326  6.21   2.52   1.256 5.615908 2.49792 1.2708
## 1st Qu.      718.750  0.00 225.00 395.000 0.000115 0.00490 0.0318
## Median      1020.625  0.00 384.38 580.000 0.000279 0.00829 0.0464
## 3rd Qu.     1398.750 20.00 609.38 810.000 0.000555 0.01296 0.0643
## 
## $`stress 1`
##                   L    L1     L2     L3       H1      H2     H3
## mean        1193.39 20.83 501.10 671.46 0.000417 0.01066 0.0536
## sd           623.48 29.09 363.57 361.21 0.000415 0.00756 0.0285
## skewness       1.01  2.09   1.36   1.02 1.973337 1.35075 1.0283
## ex kurtosis    0.94  6.14   2.23   1.22 5.630153 2.23353 1.2382
## 1st Qu.      739.38  0.00 234.38 405.00 0.000120 0.00512 0.0328
## Median      1065.62 20.00 412.50 605.00 0.000290 0.00878 0.0483
## 3rd Qu.     1505.62 40.00 675.00 865.00 0.000578 0.01422 0.0688
## 
## $`stress 2`
##                   L    L1     L2     L3       H1      H2     H3
## mean        1224.76 21.13 519.17 684.46 0.000423 0.01102 0.0547
## sd           707.59 29.61 410.43 390.67 0.000427 0.00851 0.0308
## skewness       1.48  2.13   1.77   1.28 2.034985 1.76908 1.2802
## ex kurtosis    2.69  6.49   4.18   2.15 6.009169 4.26790 2.1077
## 1st Qu.      739.38  0.00 234.38 405.00 0.000121 0.00512 0.0328
## Median      1065.62 20.00 412.50 605.00 0.000293 0.00878 0.0484
## 3rd Qu.     1505.62 40.00 675.00 870.00 0.000584 0.01430 0.0692
\end{verbatim}

The information on individual stresses can be recovered through the \texttt{get\_specs} function and the actual scenario weitghts using \texttt{get\_weight}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{get_specs}\NormalTok{(stress.credit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##            type k alpha       q            s
## stress 1    VaR L   0.9 2174.25         <NA>
## stress 2 VaR ES L   0.9 2174.25 2848.5562625
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{w <-}\StringTok{ }\KeywordTok{get_weights}\NormalTok{(stress.credit)}
\KeywordTok{colMeans}\NormalTok{(w)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## stress 1 stress 2 
##        1        1
\end{verbatim}

+++HERE WE COULD USE THE ``expected shortfall'' FUNCTION (NOT AVAILABLE YET) TO CALCULATE THE EXPECTED SHORTFALL OF ``stress.credit\$stress1''

\hypertarget{visual-comparison}{%
\subsection{Visual comparison}\label{visual-comparison}}

The change of the distributions of the portfolio and subportfolios from the baseline to the stressed models can be visualised through \texttt{plot\_hist} and \texttt{plot\_cdf}. The following plot displays the empirical histogramm of the aggregate portfolio loss under the baseline and the two stressed models.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{plot_hist}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit, }\DataTypeTok{xCol =} \StringTok{"L"}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{04-Credit-Model_files/figure-latex/CM-histL-1.pdf}

Both functions,\texttt{plot\_hist} and \texttt{plot\_cdf}, include the parameters \texttt{xCol} specifying the columns of the data and \texttt{wCol} determining the columns of the scenario weights. Thus, allowing to plot the impact of the stressed models on the subportfoios. The graphical functions \texttt{plot\_hist} and \texttt{plot\_cdf} functions return objects compatible with the package \textbf{ggplot2}. Thus, we can compare the histograms of the portfolio losses via the function \texttt{grid.arrange} (of the package \textbf{gridExtra}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(gridExtra)}
\NormalTok{pL1 <-}\StringTok{ }\KeywordTok{plot_hist}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit, }\DataTypeTok{xCol =} \DecValTok{2}\NormalTok{, }\DataTypeTok{wCol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{pL2 <-}\StringTok{ }\KeywordTok{plot_hist}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit, }\DataTypeTok{xCol =} \DecValTok{3}\NormalTok{, }\DataTypeTok{wCol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{pL3 <-}\StringTok{ }\KeywordTok{plot_hist}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit, }\DataTypeTok{xCol =} \DecValTok{4}\NormalTok{, }\DataTypeTok{wCol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{base =} \OtherTok{TRUE}\NormalTok{)}
\KeywordTok{class}\NormalTok{(pL1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "gg"     "ggplot"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{grid.arrange}\NormalTok{(pL1, pL2, pL3, }\DataTypeTok{ncol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{nrow =} \DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{04-Credit-Model_files/figure-latex/CM-plot1-1.pdf}

From the plots we observe, that the subportfolios \(L_2\) and \(L_3\) are significanlty affected by the stress, while the distribution of \(L_1\) is almost unchanged.

\hypertarget{sensitivity-measures}{%
\subsection{Sensitivity measures}\label{sensitivity-measures}}

The impact of the stressed models on the model components can be quantified through sensitivity measures. The function \texttt{sensitivity} includes the \emph{Kolmogorov}, the \emph{Wasserstein} distance and the sensitivity measure \emph{Gamma}, which can be specified through the optional parameter \texttt{type}. We refer to Section \ref{Sec:analysis} for the definition. The Kolmogorov and the Wasserstein distance are useful to compare different stressed models, whereas the sensitivity measure Gamma ranks model components for one stressed model.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{sensitivity}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit, }\DataTypeTok{xCol =} \KeywordTok{c}\NormalTok{(}\DecValTok{2} \OperatorTok{:}\StringTok{ }\DecValTok{7}\NormalTok{), }\DataTypeTok{wCol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{type =} \StringTok{"Gamma"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     stress  type   L1    L2    L3    H1    H2    H3
## 1 stress 1 Gamma 0.15 0.819 0.772 0.196 0.811 0.767
\end{verbatim}

Using the \texttt{sensitivity} function we can analyse whether the first and third tranches are able to exceed the riskiness of the second. This can be accomplished specifying, through the option \texttt{f}, a list of functions applicable to the columns \texttt{k} of the dataset. Finally, setting \texttt{xCol\ =\ NULL} allows to consider only the transformed data:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{sensitivity}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit,}\DataTypeTok{type =} \StringTok{"Gamma"}\NormalTok{, }\DataTypeTok{f =} \KeywordTok{list}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x)x[}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\StringTok{ }\NormalTok{x[}\DecValTok{2}\NormalTok{]), }
            \DataTypeTok{k =} \KeywordTok{list}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)), }\DataTypeTok{xCol =} \OtherTok{NULL}\NormalTok{, }\DataTypeTok{wCol =} \DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     stress  type    f1
## 1 stress 1 Gamma 0.783
\end{verbatim}

The \texttt{importance\_rank} function, having the same structure as the \texttt{sensitivity} function, return the ranks of the sensitivity measures. This function is particularly useful when there are several risk factors involved.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{importance_rank}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ stress.credit, }\DataTypeTok{xCol =} \KeywordTok{c}\NormalTok{(}\DecValTok{2} \OperatorTok{:}\StringTok{ }\DecValTok{7}\NormalTok{), }\DataTypeTok{wCol =} \DecValTok{1}\NormalTok{, }\DataTypeTok{type =} \StringTok{"Gamma"}\NormalTok{)  }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     stress  type L1 L2 L3 H1 H2 H3
## 1 stress 1 Gamma  6  1  3  5  2  4
\end{verbatim}

It transpires that subportfolios \(2\) and \(3\) are, in this order, most responsible for the stress in the global loss. Also, most of the sensitivity seems to be due to the systematic risk components \(H_2\) and \(H_3\). To confirm this, another stress resulting in the same \(\text{VaR}_{90\%}(L)\), but controlling the distribution of \(H_2\), can be imposed using the function \texttt{stress\_moment}. More precisely, we impose that \(E[H_2]\) and the \(75\%\) quantile of \(H_2\) are fixed as in the base model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{VaR.L <-}\StringTok{ }\KeywordTok{quantile}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ credit_data[, }\StringTok{"L"}\NormalTok{], }\DataTypeTok{prob =} \FloatTok{0.9}\NormalTok{, }\DataTypeTok{type =} \DecValTok{1}\NormalTok{)}
\NormalTok{q.H2 <-}\StringTok{ }\KeywordTok{quantile}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ credit_data[, }\StringTok{"H2"}\NormalTok{], }\DataTypeTok{prob =} \FloatTok{0.75}\NormalTok{, }\DataTypeTok{type =} \DecValTok{1}\NormalTok{)}
\NormalTok{str.var.credit2 <-}\StringTok{ }\KeywordTok{stress_moment}\NormalTok{(}\DataTypeTok{x =}\NormalTok{ credit_data,}
                                \DataTypeTok{f =} \KeywordTok{list}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(x)}\DecValTok{1} \OperatorTok{*}\StringTok{ }\NormalTok{(x }\OperatorTok{<=}\StringTok{ }\NormalTok{VaR.L }\OperatorTok{*}\StringTok{ }\FloatTok{1.2}\NormalTok{),}
                                         \ControlFlowTok{function}\NormalTok{(x)x,}
                                         \ControlFlowTok{function}\NormalTok{(x)}\DecValTok{1} \OperatorTok{*}\StringTok{ }\NormalTok{(x }\OperatorTok{<=}\StringTok{ }\NormalTok{q.H2)),}
                                \DataTypeTok{m =} \KeywordTok{c}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\KeywordTok{mean}\NormalTok{(credit_data[, }\StringTok{"H2"}\NormalTok{]), }\FloatTok{0.75}\NormalTok{),}
                                \DataTypeTok{k =} \KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\CommentTok{# stress.credit <- stress_moment(x = stress.credit,}
\CommentTok{#                                f = list(function(x)1 * (x <= VaR.L * 1.2),}
\CommentTok{#                                         function(x)x,}
\CommentTok{#                                         function(x)1 * (x <= q.H2)),}
\CommentTok{#                                m = c(0.9, mean(credit_data[, "H2"]), 0.75), k = c(1, 6, 6))}
\KeywordTok{summary}\NormalTok{(str.var.credit2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## $`stress 1`
##                    L    L1    L2     L3       H1      H2     H3
## mean        1140.535 20.06 456.0 664.47 0.000400 0.00968 0.0530
## sd           616.930 28.48 340.9 371.14 0.000405 0.00706 0.0292
## skewness       1.059  2.13   1.4   1.09 2.013196 1.39135 1.0949
## ex kurtosis    0.895  6.40   2.3   1.31 5.899634 2.26506 1.3371
## 1st Qu.      695.000  0.00 206.2 395.00 0.000113 0.00453 0.0318
## Median      1001.875  0.00 365.6 590.00 0.000276 0.00786 0.0472
## 3rd Qu.     1430.625 20.00 609.4 855.00 0.000554 0.01296 0.0679
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# summary(stress.credit)}
\KeywordTok{sensitivity}\NormalTok{(}\DataTypeTok{object =}\NormalTok{ str.var.credit2, }\DataTypeTok{xCol =} \KeywordTok{c}\NormalTok{(}\DecValTok{2} \OperatorTok{:}\StringTok{ }\DecValTok{7}\NormalTok{), }\DataTypeTok{type =} \StringTok{"Gamma"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##     stress  type     L1     L2    L3        H1       H2    H3
## 1 stress 1 Gamma 0.0102 0.0203 0.366 -0.000521 1.17e-08 0.359
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# sensitivity(object = stress.credit, xCol = c(2 : 7), type = "Gamma")}
\end{Highlighting}
\end{Shaded}

+++THIS SHOULD BE APPENDED TO ``stress.credit'' WHEN ``stress\_moment'' IS FIXED
It is then clear that systematic risk prevails on binomial (event) risk.

The \texttt{stress\_moment} function is flexible and allows different type of stresses to be imposed on a model. The following example forces a \(50\%\) increase in correlation between the losses in the second and third portfolios, while keeping the means und standard deviations unchanged.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m.L2 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(credit_data[, }\StringTok{"L2"}\NormalTok{])}
\NormalTok{m.L3 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(credit_data[, }\StringTok{"L3"}\NormalTok{])}
\NormalTok{m2.L2 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(credit_data[, }\StringTok{"L2"}\NormalTok{] }\OperatorTok{^}\StringTok{ }\DecValTok{2}\NormalTok{)}
\NormalTok{m2.L3 <-}\StringTok{ }\KeywordTok{mean}\NormalTok{(credit_data[, }\StringTok{"L3"}\NormalTok{] }\OperatorTok{^}\StringTok{ }\DecValTok{2}\NormalTok{)}
\NormalTok{cov.L2.L3 <-}\StringTok{ }\KeywordTok{cov}\NormalTok{(credit_data[, }\StringTok{"L2"}\NormalTok{], credit_data[, }\StringTok{"L3"}\NormalTok{])}
\CommentTok{# str.var.credit2 <- stress_moment(x = credit_data,}
\CommentTok{#                                 f = list(function(x)x,}
\CommentTok{#                                          function(x)x,}
\CommentTok{#                                          function(x)x ^ 2,}
\CommentTok{#                                          function(x)x ^ 2,}
\CommentTok{#                                          function(x)x[1] * x[2] - m.L2 * m.L3),}
\CommentTok{#                                 k = list(3, 4, 3, 4, c(3, 4)),}
\CommentTok{#                                 m = c(m.L2, m.L3, m2.L2, m2.L3, cov.L2.L3 * 1.5)}
\end{Highlighting}
\end{Shaded}

+++CURRENTLY DOES NOT RUN - NEEDS TO BE FIXED OR REPLACED

+++FINAL COMMENTS?

\hypertarget{appendix-appendix}{%
\appendix}


\hypertarget{AppendixCM}{%
\section{Appendix Credit Model}\label{AppendixCM}}

\hypertarget{credit-model-assumptions}{%
\subsection{Credit Model assumptions}\label{credit-model-assumptions}}

The credit model is based on the conditionally binomial credit model described in \citet{Mcneil2015B} which belongs to the family of mixture models. Specifically, we consider a portfolio that consists of three homogeneous sub-portfolios and denote the total aggregate loss of the portfolio by \(L = L_1 + L_2+ L_2\), where \(L_1, L_2, L_3\) are the aggregate losses of each sub-portfolio, given by
\begin{equation}
L_i=e_i\cdot\text{LGD}_i\cdot M_i,\quad i=1,2,3, 
\end{equation}
where \(e_i\) and \(M_i\) are the exposure and number of insolvencies of the \(i^{\text{th}}\) sub-portfolio, respectively, and \(\text{LGD}_i\) is the loss given default of sub-portfolio \(i\). The number of insolvencies of the \(i^{\text{th}}\) sub-portfolio \(M_i\) is, conditionally on a \([0,1]\) valued random variable \(H_i\), independent and Binomially distributed with parameters \(m_i\), the sub-portfolio size, and common random probability \(H_i\). \(H_i, ~ i = 1,2,3\) follows a Beta distribution with parameters chosen such as to match the default probability \(p_i\) and the default correlation \(\rho_i\), that is the correlation between two default events within a sub-portfolio, see \citet{Mcneil2015B}. The dependence structure of \((H_1,H_2,H_3)\) is modelled via a Gaussian copula with correlation matrix\\
\begin{equation}\Sigma = \begin{pmatrix}
1 & 0.3 & 0.1\\
0.3 & 1 & 0.4\\
0.1 & 0.4 & 1
\end{pmatrix}.\end{equation}

The subsequent table summarises the parameter values used in the simulation.

\begin{longtable}[]{@{}llllll@{}}
\toprule
\(i\) & \(m_i\) & \(e_i\) & \(p_i\) & \(\rho_i\) & \(LGD_i\)\tabularnewline
\midrule
\endhead
1 & 2500 & 80 & 0.0004 & 0.00040 & 0.250\tabularnewline
2 & 5000 & 25 & 0.0097 & 0.00440 & 0.375\tabularnewline
3 & 2500 & 10 & 0.0503 & 0.01328 & 0.500\tabularnewline
\bottomrule
\end{longtable}

\hypertarget{code-for-generating-the-data}{%
\subsection{Code for generating the data}\label{code-for-generating-the-data}}

\begin{Shaded}
\begin{Highlighting}[]
  \KeywordTok{library}\NormalTok{(SWIM)}
  \KeywordTok{set.seed}\NormalTok{(}\DecValTok{1}\NormalTok{)}
  \KeywordTok{library}\NormalTok{(copula)}
\NormalTok{  nsim <-}\StringTok{ }\DecValTok{100000}
  
\CommentTok{# data}
\NormalTok{  m1 <-}\StringTok{ }\DecValTok{2500} \CommentTok{# counterparties tranche A}
\NormalTok{  m2 <-}\StringTok{ }\DecValTok{5000} \CommentTok{# counterparties tranche B}
\NormalTok{  m3 <-}\StringTok{ }\DecValTok{2500} \CommentTok{# counterparties tranche C}
  
\NormalTok{  p1 <-}\StringTok{ }\FloatTok{0.0004} \CommentTok{# prob of default }
\NormalTok{  rho1 <-}\StringTok{ }\FloatTok{0.0004} \CommentTok{# correlation within the tranche}

\NormalTok{  p2 <-}\StringTok{ }\FloatTok{0.0097} 
\NormalTok{  rho2 <-}\StringTok{ }\FloatTok{0.0044}
  
\NormalTok{  p3 <-}\StringTok{ }\FloatTok{0.0503}  
\NormalTok{  rho3 <-}\StringTok{ }\FloatTok{0.01328}
  
\CommentTok{# exposures}
\NormalTok{  e1 <-}\StringTok{ }\DecValTok{80}
\NormalTok{  e2 <-}\StringTok{ }\DecValTok{25} 
\NormalTok{  e3 <-}\StringTok{ }\DecValTok{10} 
  
\CommentTok{# loss given default}
\NormalTok{  LGD1 <-}\StringTok{ }\FloatTok{0.25}
\NormalTok{  LGD2 <-}\StringTok{ }\FloatTok{0.375}
\NormalTok{  LGD3 <-}\StringTok{ }\FloatTok{0.5}
  
\CommentTok{# beta-binomial model with copula }
  
\CommentTok{# beta parameters: matching tranches default probabilities and correlation}
\NormalTok{  alpha1 <-}\StringTok{ }\NormalTok{p1 }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{rho1 }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{  beta1 <-}\StringTok{ }\NormalTok{alpha1 }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{p1 }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
  
\NormalTok{  alpha2 <-}\StringTok{ }\NormalTok{p2 }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{rho2 }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{  beta2 <-}\StringTok{ }\NormalTok{alpha2 }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{p2 }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
  
\NormalTok{  alpha3 <-}\StringTok{ }\NormalTok{p3 }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{rho3 }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{  beta3 <-}\StringTok{ }\NormalTok{alpha3 }\OperatorTok{*}\StringTok{ }\NormalTok{(}\DecValTok{1} \OperatorTok{/}\StringTok{ }\NormalTok{p3 }\OperatorTok{-}\StringTok{ }\DecValTok{1}\NormalTok{)}
  
\CommentTok{# correlations between sub-portfolios}
\NormalTok{  cor12 <-}\StringTok{ }\FloatTok{0.3}
\NormalTok{  cor13 <-}\StringTok{ }\FloatTok{0.1}
\NormalTok{  cor23 <-}\StringTok{ }\FloatTok{0.4}
  
\CommentTok{# Gaussian copula structure}
\NormalTok{  myCop <-}\StringTok{ }\KeywordTok{normalCopula}\NormalTok{(}\DataTypeTok{param =} \KeywordTok{c}\NormalTok{(cor12, cor13, cor23), }\DataTypeTok{dim =} \DecValTok{3}\NormalTok{, }\DataTypeTok{dispstr =} \StringTok{"un"}\NormalTok{)}
  
\CommentTok{# define multivariate beta with given copula}
\NormalTok{  myMvd <-}\StringTok{ }\KeywordTok{mvdc}\NormalTok{(}\DataTypeTok{copula =}\NormalTok{ myCop,}
                \DataTypeTok{margins =} \KeywordTok{c}\NormalTok{(}\StringTok{"beta"}\NormalTok{, }\StringTok{"beta"}\NormalTok{, }\StringTok{"beta"}\NormalTok{),}
                \DataTypeTok{paramMargins =} \KeywordTok{list}\NormalTok{(}\KeywordTok{list}\NormalTok{(alpha1, beta1),}
                                    \KeywordTok{list}\NormalTok{(alpha2, beta2),}
                                    \KeywordTok{list}\NormalTok{(alpha3, beta3)))}

\CommentTok{# simulation from the chosen copula}
\NormalTok{  H <-}\StringTok{ }\KeywordTok{rMvdc}\NormalTok{(nsim, myMvd)}
  
\CommentTok{# simulate number of default per tranches (binomial distributions)}
\NormalTok{  M1 <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ nsim, }\DataTypeTok{size =}\NormalTok{ m1, }\DataTypeTok{prob =}\NormalTok{ H[, }\DecValTok{1}\NormalTok{])}
\NormalTok{  M2 <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ nsim, }\DataTypeTok{size =}\NormalTok{ m2, }\DataTypeTok{prob =}\NormalTok{ H[, }\DecValTok{2}\NormalTok{])}
\NormalTok{  M3 <-}\StringTok{ }\KeywordTok{rbinom}\NormalTok{(}\DataTypeTok{n =}\NormalTok{ nsim, }\DataTypeTok{size =}\NormalTok{ m3, }\DataTypeTok{prob =}\NormalTok{ H[, }\DecValTok{3}\NormalTok{])}
  
\CommentTok{# total loss per sub-portfolio}
\NormalTok{  L1 <-}\StringTok{ }\NormalTok{M1 }\OperatorTok{*}\StringTok{ }\NormalTok{e1 }\OperatorTok{*}\StringTok{ }\NormalTok{LGD1}
\NormalTok{  L2 <-}\StringTok{ }\NormalTok{M2 }\OperatorTok{*}\StringTok{ }\NormalTok{e2 }\OperatorTok{*}\StringTok{ }\NormalTok{LGD2}
\NormalTok{  L3 <-}\StringTok{ }\NormalTok{M3 }\OperatorTok{*}\StringTok{ }\NormalTok{e3 }\OperatorTok{*}\StringTok{ }\NormalTok{LGD3}
  
\CommentTok{# aggregate portfolio loss}
\NormalTok{  L <-}\StringTok{ }\NormalTok{L1 }\OperatorTok{+}\StringTok{ }\NormalTok{L2 }\OperatorTok{+}\StringTok{ }\NormalTok{L3}
  
\CommentTok{# DB for SWIM}
\NormalTok{  credit_data <-}\StringTok{ }\KeywordTok{cbind}\NormalTok{(L, L1, L2, L3, H)}
  \KeywordTok{colnames}\NormalTok{(credit_data) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"L"}\NormalTok{, }\StringTok{"L1"}\NormalTok{, }\StringTok{"L2"}\NormalTok{, }\StringTok{"L3"}\NormalTok{, }\StringTok{"H1"}\NormalTok{, }\StringTok{"H2"}\NormalTok{, }\StringTok{"H3"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\bibliography{bibliography.bib}


\end{document}
