
# Case study {#Sec:CreditModel}

## A credit risk portfolio 
```{r,echo=FALSE,message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)
```

```{r, loading-packages, cache = FALSE, include = FALSE}
#  library(SWIM)
  library(ggplot2)
  library(gridExtra)
```

The credit model in this section is a conditionally binomial loan portfolio model including systematic and specific portfolio risk. We refer to the Appendix \@ref(AppendixCM) for details about the model and the generation of the simulated data. A key variable of interest is the total aggregate portfolio loss $L = L_1 + L_2 + L_3$, where $L_1, L_2, L_3$ are homogeneous subportfolios on  comparable scale (say, thousands of \$). The dataset contains 100,000 simulations of the portfolio $L$, the subportfolios $L_1, L_2, L_3$ as well as the default probability of each subportfolio $H_1, H_2, H_3$. These random default probabilities represent the sytematic risk *within* each subportfolio, while their dependence structure represents a systematic risk effect *between* the subportfolios. The simulated data of the credit risk portfolio is included in the **SWIM** package and can be accessed via `data("credit_data")`. A snippet of the dataset looks as follows:

```{r, CM-data-head, echo = -2, cache = TRUE}
data("credit_data")
options(digits = 3)
head(credit_data)
``` 


## Stressing the aggregate portfolio loss 

In this section, following a reverse sensitivity approach, we study the effects that stresses on (the tail of) the aggregate portfolio have on the three subportfolios. Through this analysis, we aim to assess the comparative importance of the three subportfolios.

First, we impose a $20\%$ increase on the VaR at level 0.9 of the loss of the aggregate portfolio.

```{r, CM-stress-VaR, cache = FALSE, echo = TRUE}
stress.credit <- stress(type = "VaR", x = credit_data, k = "L", 
                        alpha = 0.9, q_ratio = 1.2)
```

The imposed change in VaR determines an increase in ES.
```{r, CM-stress-VaR-check-ES, cache = FALSE}
VaR_stressed(object = stress.credit, alpha = 0.9, xCol = "L", base = TRUE)
ES_stressed(object = stress.credit, alpha = 0.9, xCol = "L", base = TRUE)
```


We then consider, additionally to the $20\%$ increase in $\text{VaR}_{0.9}$, a further increase in $\text{ES}_{0.9}$ of the aggregate portfolio $L$. Note that, when stressed together, both VaR and ES need be stressed at the same level `alpha = 0.9`. Instead of providing the percentage increases in the VaR and ES through the arguments `q_ratio` and `s_ratio`, the actual stressed values of VaR and ES can be set using the arguments `q` and `s`, respectively. 


```{r, CM-stress-VaR-ES, cache = FALSE}
stress.credit <- stress(type = "VaR ES", x = stress.credit, k = "L", alpha = 0.9, q_ratio = 1.2, s = 3500)
```

When applying the `stress` function, or one of its alternative versions, to a **SWIM** object, the result will be a new **SWIM** object where the new stress has been "appended" to the previous one. This is convenient when large datasets are involved, as the `stress` function returns an object  containing the original simulated data and the scenario weights. 

## Analysing stressed models

The `summary` function provides a statistical summary of the stressed models. Choosing  `base = TRUE`, compares the stressed models with the the baseline model.

```{r, CM-summary, echo = -1, cache = TRUE}
options(digits = 3)
summary(stress.credit, base = TRUE)
```
Note that `stress 1` is the `summary` output corresponds to the 20% increase in the VaR, while `stress 2` corresponds to the stress of both VaR and ES. The information on individual stresses can be recovered through the `get_specs` function, and the actual scenario weights using `get_weights`.

```{r, CM-specs, echo = -1, cache = TRUE}
options(digits = 3)
get_specs(stress.credit)
w <- get_weights(stress.credit)
```

+++ SILVANA to check to R code+++

``` {r, credit-weights, warning = FALSE, message = FALSE, fig.show='hold', out.width = '50%',fig.cap = "Scenario weights against the aggregat portfolio $L$ for stressing VaR (left) and stressing both VaR and ES (right)."}
# extract weights from SWIM object
w.credit <- get_weights(stress.credit)
plot(credit_data[,1], w.credit[,1], pch = 20, xlab = "L", ylab = "scenario weights")
plot(credit_data[,1], w.credit[,2], pch = 20, xlab = "L", ylab = "scenario weights")
```

It is seen that the weights generated to stress VaR, and VaR and ES together, follow a different pattern to the weights used to stress means and standard deviations, as shown in Section \@ref(Sec:Intro).

## Visual comparison
The change in the distributions of the portfolio and subportfolios from the baseline to the stressed models can be visualised through the functions `plot_hist` and `plot_cdf`. The following figure displays the histogram of the aggregate portfolio loss under the baseline and the two stressed models. It is seen how stressing VaR and ES has a higher impact on the right tail of $L$, compared to stressing VaR only. This is consistent with the tail-sensitive nature of the Expected Shortfall risk measure [@Mcneil2015B].

```{r, CM-histL, cache = TRUE}
plot_hist(object = stress.credit, xCol = "L", base = TRUE)
```

The arguments `xCol` and `wCol` (with default to plot all stresses) specify the columns of the data to be plotted and the scenario weights to be used, respectively. The impact on the subportfolios of stressing the aggregate loss can thus be investigated. The graphical functions `plot_hist` and `plot_cdf` return objects compatible with the package **ggplot2**. Therefore, we can for instance place the histograms of portfolio losses along each other via the function `grid.arrange` (from the package **gridExtra**) and understand how each subportfolio reacts to the different stresses.

```{r, CM-plot1, cache = TRUE}
pL2.stress1 <- plot_hist(object = stress.credit, xCol = 3, wCol = 1, base = TRUE)
pL2.stress2 <- plot_hist(object = stress.credit, xCol = 3, wCol = 2, base = TRUE)
grid.arrange(pL2.stress1, pL2.stress2, ncol = 1, nrow = 2)
```

The tail of the subportfolio $L_2$ is more affected by the second than the first stress, which reflects the additional stress on the ES>

+++ Andreas' comment: Why are we only showing L2?+++

## Sensitivity measures

The impact of the stressed models on the model components can be quantified through sensitivity measures. The function `sensitivity` includes the *Kolmogorov* distance, the *Wasserstein* distance, and the sensitivity measure *Gamma*, which can be specified through the optional argument `type`. We refer to Section \@ref(Sec:analysis) for the definitions of these measures. The Kolmogorov and the Wasserstein distances are useful to compare different stressed models, whereas the sensitivity measure Gamma ranks model components for one stressed model.

```{r, CM-sensitivity1, cache = TRUE}
sensitivity(object = stress.credit, xCol = c(2 : 7), wCol = 1, type = "Gamma")
```

Using the `sensitivity` function we can analyse whether the sensitivity of the joint subportfolio $L_1 + L_3$ exceeds the sensitivity of the subportfolio $L_2$. This can be accomplished by specifying, through the option `f`, a list of functions applicable to the columns `k` of the dataset. Setting `xCol = NULL` only the transformed data is considered. The sensitivity measure of a function of the columns is particularly useful when high dimensional models are considered and such summaries are needed in order to compare blocks of model components against each others.

```{r, CM-sensitivity2, cache = TRUE}
sensitivity(object = stress.credit, type = "Gamma", f = list(sum), 
            k = list(c(2, 4)), wCol = 1, xCol = NULL)
```

We obserce that the sensitivity of $L_1 + L_3$ is larger than the sensitivity to both $L_1$ and $L_3$, reflecting the positive dependence structre of the credit risk portfolio. Moreover, subportfolio $L_2$ has not only the largest sensitivity compared to $L_1$ and $L_3$ but also a higher sensitivity than the combined subportfolios $L_1 + L_3$. 

++++CAN WE ALLOW FOR "f" and "k" TO BE A FUNCTION AND A VECTOR, RESPECTIVELY, AS IN stress_moments? RIGHT NOW WE NEED TO USE "list(SUM)"++++ --- Silvana: the sensitivity function has arguments f and k, which are the same as the one specified in stress_moments. The problem is that if k has length >1, both f and k must be a list. We could change it to, if f is a function and k a vector then the same function is applied to all k's. ---

The `importance_rank` function, having the same structure as the `sensitivity` function, returns the ranks of the sensitivity measures. This function is particularly useful when several risk factors are involved.

```{r, CM-rank, cache = TRUE}
importance_rank(object = stress.credit, xCol = c(2 : 7), wCol = 1, type = "Gamma")
importance_rank(object = stress.credit, xCol = c(2 : 7), wCol = 2, type = "Gamma")
```


## Advanced stresses

It transpires that subportfolios $L_2$ and $L_3$ are, in this order, most responsible for the stress in the global loss, under both stresses considered. Also, most of the sensitivity seems to be attributable to the systematic risk components $H_2$ and $H_3$. To investigate this, we perform another stress resulting once again in a 20% increase in $\text{VaR}_{90\%}(L)$, but this time controlling for the distribution of $H_2$. Specifically, by fixing the mean of $H_2$ and the $75\%$ quantile of $H_2$ to the same values as in the baseline model. This set of constraints is implemented via the function `stress_moment`.

+++THE APPENDING OF STRESS_MOMENT IS STILL NOT WORKING PROPERLY.+++

```{r, CM-stress-fixed-VaR, cache = TRUE, tidy = FALSE}
VaR.L <- quantile(x = credit_data[, "L"], prob = 0.9, type = 1) # VaR of L
q.H2 <- quantile(x = credit_data[, "H2"], prob = 0.75, type = 1) # quantile of H2
k.stressH2 = c(1, 6, 6) # columns to be stressed (L, H2, H2)
# functions to be applied to columns
f.stressH2 <- list(function(x)1 * (x <= VaR.L * 1.2), # indicator function for L
                 function(x)x, # mean of H2
                 function(x)1 * (x <= q.H2)) # indicator function for H2
# new values for the VaR of L, mean of H2, quantile of H2
m.stressH2 = c(0.9, mean(credit_data[, "H2"]), 0.75) 
stress.credit.H2 <- stress_moment(x = credit_data, f = f.stressH2, k = k.stressH2, m = m.stressH2)
```

In this case we can use the `summary` function to verify the change of the distribution of $H_2$ under the new stress.

+++IS IT COMPLEX TO ADD TO THE SUMMARY FUNCTION THE POSSIBILITY OF SPECIFYING WHICH STRESS TO CONSIDER? IN THIS CASE FOR EXAMPLE SOMEONE COULD BE INTERESTED ONLY ON THE NEW STRESS AND THE BASELINE+++
---Silvana: you can do this with the argument wCol, which can be a vector, say you want to have stresses 1 and 3 and the baseline, choose wCol = c(1,3) and base = TRUE---

```{r, summary-sens-H2, echo = -1, cache = TRUE}
options(digits = 3)
summary(stress.credit.H2, base = TRUE)
sensitivity(object = stress.credit.H2, xCol = c(2:7), type = "Gamma")
```

The sensitivity measure confirms that the systematic risk prevails on binomial (event) risk. +++More interpretation+++


+++Add motivating sentence+++

The following example is another case involving the stress of multiple model components. Namely, we impose a stress requiring a 20\% increase in the quantile of both the losses in subportfolios $L2$ and $L3$. In particular, we can examine two different situations: in the first the minimization problem is subject to two separate constraints while in the second it is subject to a joint one. 

```{r, CM-joint-stress-VaR, echo = -1, cache = TRUE}
options(digits = 3)
VaR.L2 <- quantile(x = credit_data[, "L2"], prob = 0.9, type = 1) # VaR of L2
VaR.L3 <- quantile(x = credit_data[, "L3"], prob = 0.9, type = 1) # VaR of L3
# functions to be applied to columns
 
# two constraints
f.stress <- list(function(x)1 * (x <= VaR.L2 * 1.2), function(x)1 * (x <= VaR.L3 * 1.2)) 
# single joint constraint
f.stress.joint <- list(function(x)1 * (x[1] <= VaR.L2 * 1.2) * (x[2] <= VaR.L3 * 1.2)) 
stress.credit.L2L3 <- stress_moment(x = credit_data, f = f.stress, k = c(3, 4), m = c(0.9, 0.9))
stress.credit.L2L3.joint <- stress_moment(x = credit_data, f = f.stress.joint, 
                                          k = list(c(3, 4)), m = 0.9)
summary(stress.credit.L2L3)
summary(stress.credit.L2L3.joint)
```

The stress obtained with the joint constraint on $L_2$ and $L_3$ is weaker. +++ Interpretation?+++


